description: >
  Halts redundant CI runs if watched directories are unchanged

parameters:
  # === FROM iynere/compare-url ===
  circle-token:
    description: >
      Your CircleCI API token, defaults to $CIRCLE_TOKEN
    type: env_var_name
    default: CIRCLE_TOKEN

  project-path:
    description: >
      Absolute path to your project's base directory,
      necessary for running git commands
    type: string
    default: ~/project

  debug:
    description: >
      Additional debugging output for folks developing the orb
    type: boolean
    default: false

  # Original
  watch:
    description: >
      Directories to watch for changes, separated by spaces
    type: string
    default: ".circleci"

# We use CIRCLE_COMPARE_URL to halt redundant jobs
# Saving you time, and in turn TONS in runtime costs
steps:
  - run:
      name: "[runtime-optimizer/halt-if-unchanged] - Halting if watch files are unchanged"
      command: |
        if [ -z ${CIRCLE_COMPARE_URL+x} ]
        then
          echo "$CIRCLE_COMPARE_URL unset - seeing if it was saved to workspace"
          echo "iynere/compare-url will do so automatically using compare-url/reconstruct"
          CIRCLE_COMPARE_URL=$(cat CIRCLE_COMPARE_URL.txt)
        fi
        echo "----------------------------------------------------------------------------------------------------"
        echo "Checking for changes:"
        echo $CIRCLE_COMPARE_URL
        echo "<<parameters.watch>>"
        echo "----------------------------------------------------------------------------------------------------"
        pwd
        ls -l
        echo "----------------------------------------------------------------------------------------------------"
        # Invoke script
        sh ./src/scripts/check-changes.sh "${CIRCLE_COMPARE_URL}" "<<parameters.watch>>" || circleci step halt
